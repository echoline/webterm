#!/bin/rc

fn sigint {
	echo -n > /dev/innerHTML
	{
		echo 'hedit'^$pid^'log = undefined;'
		echo 'hedit'^$pid^'sent = undefined;'
		echo 'hedit'^$pid^'read = undefined;'
		echo 'hedit'^$pid^' = undefined;'
		echo 'rmfile("/hedit'^$pid^'");'
	} > /dev/js
	label $"ol
}

fn sigexit {
	sigint
}

fn openfile {
	if (test -d $"filename) {
		lc $"filename >[2=1] > /dev/dom/0/children/0/children/1/children/0/children/0/value && echo $"filename directory
	}
	if not {
		cp $"filename /dev/dom/0/children/0/children/1/children/0/children/0/value >[2=1] && echo $"filename opened
	}
}

fn savefile {
	if (test -d $"filename) {
		echo $"filename is a directory
	}
	if not {
		cp /dev/dom/0/children/0/children/1/children/0/children/0/value $"filename >[2=1] && echo $"filename saved
	}
}

filename=''
if (test $#* -gt 0)
	filename=$"1

fn load {
{
	echo '<table style="width:100%; height:100%;"><tbody><tr><td>filename:</td><td width="100%">'
	echo '<input style="width:98%" type="text" value="'^$"filename^'" spellcheck="false"/></td>'
	echo '<td><input type="button" value="open" onclick="javascript:hedit'^$pid^'(''open'')"/></td>'
	echo '<td><input type="button" value="save" onclick="javascript:hedit'^$pid^'(''save'');"/></td>'
	echo '<td><input type="button" value="quit" onclick="javascript:hedit'^$pid^'(''quit'');"/></td></tr>'
	echo '<tr style="height:100%"><td colspan="5" style="height:100%">'
	echo '<textarea style="width:99%; height:100%;" spellcheck="false" onkeydown="javascript:if(event.which == 9) { var pos = this.selectionStart; this.value = this.value.substring(0, this.selectionStart) + String.fromCharCode(9) + this.value.substring(this.selectionEnd); this.selectionStart = this.selectionEnd = pos + 1; return false; }"/>'
	echo '</textarea></td></tr></tbody></table>'
} > /dev/innerHTML

if (! ~ $"filename '')
	label `{ openfile }
if not
	label hedit

{
	echo 'hedit'^$pid^'log = "";'
	echo 'hedit'^$pid^'sent = 0;'
	echo 'hedit'^$pid^'read = [];'
	echo 'mkfile("/hedit'^$pid^'", undefined,function(f, p) {'
	echo '	hedit'^$pid^'read.push(p);'
	echo '});'
	echo 'hedit'^$pid^' = function(s) {'
	echo '	hedit'^$pid^'log += s + "\n"'
	echo '	while (hedit'^$pid^'read.length > 0 && hedit'^$pid^'sent < hedit'^$pid^'log.length) {'
	echo '		var p = hedit'^$pid^'read.shift();'
	echo '		var buf = hedit'^$pid^'log.substring(p.offset, p.offset+p.count);'
	echo '		respond(p, buf);'
	echo '		hedit'^$pid^'sent += buf.length;'
	echo '	}'
	echo '}'
} > /dev/js
}

ol=`"{cat /dev/label}
load
running=1

cat /mnt/term/hedit$pid | {
while (~ $running 1 && test -f /mnt/term/hedit$pid) {
	op=`{read}
	filename=`"{cat /dev/dom/0/children/0/children/0/children/1/children/0/value}
	if (~ $"op quit) {
		running=0
		exit
	}
	if (! ~ $"filename '') {
		if (~ $"op open) {
			openfile
		}
		if (~ $"op save) {
			savefile
		}
	}
	if not {
		echo blank filename
	}
}
} | { while(read > /dev/label) {} }

sigint

