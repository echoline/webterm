#!/bin/rc

fn sigint {
	echo -n > /dev/innerHTML
	{
		echo 'hedit'^$pid^'log = undefined;'
		echo 'hedit'^$pid^'sent = undefined;'
		echo 'hedit'^$pid^'read = undefined;'
		echo 'hedit'^$pid^'io = undefined;'
		echo 'hedit'^$pid^'op = undefined;'
		echo 'rmfile("/hedit'^$pid^'");'
	} > /dev/js
	label `{cat /dev/winid}
}

filename=''
if (test $#* -gt 0)
	filename=$"1

fn load {
{
	echo '<table style="width:100%; height:100%;"><tbody><tr><td>filename:</td><td width="100%">'
	echo '<input style="width:99%" id="heditfile'^$pid^'" type="text" value="'^$"filename^'" spellcheck="false"/></td>'
	echo '<td><input type="button" value="open" onclick="javascript:hedit'^$pid^'op(''open'',document.getElementById(''heditfile'^$pid^''').value);"/></td>'
	echo '<td><input type="button" value="save" onclick="javascript:hedit'^$pid^'op(''save'',document.getElementById(''heditfile'^$pid^''').value);"/></td></tr>'
	echo '<tr style="height:100%"><td colspan="4" style="height:100%">'
	echo '<textarea style="width:99%; height:100%;" spellcheck="false" onkeydown="javascript:if(event.which == 9) { var pos = this.selectionStart; this.value = this.value.substring(0, this.selectionStart) + String.fromCharCode(9) + this.value.substring(this.selectionEnd); this.selectionStart = this.selectionEnd = pos + 1; return false; }"/>'
	echo '</textarea></td></tr></tbody></table>'
} > /dev/innerHTML

if (! ~ $"filename '' && test -f $"filename)
	cat $"filename > /dev/hsys/^`{cat /dev/winid}^/dom/0/children/0/children/1/children/0/children/0/value

{
	echo 'hedit'^$pid^'log = "";'
	echo 'hedit'^$pid^'sent = 0;'
	echo 'hedit'^$pid^'read = [];'
	echo 'mkdir("/hedit'^$pid^'");'
	echo 'mkfile("/hedit'^$pid^'/io", undefined,function(f, p) {'
	echo '	hedit'^$pid^'read.push(p);'
	echo '});'
	echo 'hedit'^$pid^'io = function(p) {'
	echo '	var buf = hedit'^$pid^'log.substring(p.offset, p.offset+p.count);'
	echo '	respond(p, buf);'
	echo '	hedit'^$pid^'sent += buf.length;'
	echo '}'
	echo 'hedit'^$pid^'op = function(op, filename) {'
	echo '	hedit'^$pid^'log += op + filename + "\n"'
	echo '	while (hedit'^$pid^'read.length > 0 && hedit'^$pid^'sent < hedit'^$pid^'log.length) {'
	echo '		hedit'^$pid^'io(hedit'^$pid^'read.shift());'
	echo '	}'
	echo '}'
} > /dev/js
}


label $"filename
load

cat /mnt/term/hedit$pid/io | {
while (test -f /mnt/term/hedit$pid/io) {
	line=`{read}
	op=`"{echo $line | dd -bs 1 -count 4 >[2]/dev/null }
	filename=`"{echo -n $line | dd -bs 1 -skip 4 >[2]/dev/null }
	if (! ~ $"filename '') {
		echo -n $"filename^' '
		if (~ $"op open) {
			if (test -f $"filename) {
				cat $"filename > /dev/hsys/^`{cat /dev/winid}^/dom/0/children/0/children/1/children/0/children/0/value
				echo opened
			}
			if not {
				echo -n > /dev/hsys/^`{cat /dev/winid}^/dom/0/children/0/children/1/children/0/children/0/value
				echo does not exist
			}
		}
		if (~ $"op save) {
			cat /dev/hsys/^`{cat /dev/winid}^/dom/0/children/0/children/1/children/0/children/0/value > $"filename
			echo saved
		}
	}
}
} | { while(read > /dev/label) {} }

sigint
