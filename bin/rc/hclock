#!/bin/rc

fn sigint {
	running=0
	sleep 1
	label $"l
	echo -n > /dev/innerHTML
}

fn clockface {
	echo '<svg viewBox="0 0 40 40" style="max-width:100%;max-height:100%;display:block;margin:auto;">'
	echo '<circle cx="2" cy="20" r="1" />'
	echo '<circle cx="4.412" cy="11" r="1" />'
	echo '<circle cx="11" cy="4.412" r="1" />'
	echo '<circle cx="20" cy="2" r="1" />'
	echo '<circle cx="29" cy="4.412" r="1" />'
	echo '<circle cx="35.588" cy="11" r="1" />'
	echo '<circle cx="38" cy="20" r="1" />'
	echo '<circle cx="35.588" cy="29" r="1" />'
	echo '<circle cx="29" cy="35.588" r="1" />'
	echo '<circle cx="20" cy="38" r="1" />'
	echo '<circle cx="11" cy="35.588" r="1" />'
	echo '<circle cx="4.412" cy="29" r="1" />'

	echo '<g></g>'
	echo '<g></g>'

	echo '<circle cx="20" cy="20" r="0.7" />'
	echo '</svg>'
}

fn clockhands {
	ifs='
 :'

	t=`{date -t | sed 's,^.*T,,
					s,-.*$,,'}

	rad=`{ echo '2*3.14159/60 * '$t(3) | hoc }
	echo '<line x1="20" y1="20" x2="'`{ echo '20 + sin('`{ echo -n $rad }') * 15' | hoc}^'" y2="'`{ echo '20 - cos('`{ echo -n $rad }') * 15' | hoc}^'" stroke="#D00" />' > /dev/dom/0/children/13/innerHTML

	if (test $t(3) -lt $lastsec) {
	{
		rad=`{ echo '2*3.14159/12 * ('$t(1)' + '$t(2)'/60)' | hoc }
		echo '<line x1="20" y1="20" x2="'`{ echo '20 + sin('`{ echo -n $rad }') * 10' | hoc}^'" y2="'`{ echo '20 - cos('`{ echo -n $rad }') * 10' | hoc}^'" stroke="#000" />'

		rad=`{ echo '2*3.14159/60 * '$t(2) | hoc }
		echo '<line x1="20" y1="20" x2="'`{ echo '20 + sin('`{ echo -n $rad }') * 15' | hoc}^'" y2="'`{ echo '20 - cos('`{ echo -n $rad }') * 15' | hoc}^'" stroke="#000" />'
	} > /dev/dom/0/children/12/innerHTML
	}

	lastsec=$t(3)

	echo > /dev/null
}

running=1
lastsec=100
l=`"{ cat /dev/label }
clockface > /dev/innerHTML
clockhands
while(~ $running 1 && date > /dev/label && clockhands) { sleep 1 }

